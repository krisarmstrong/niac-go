#!/bin/bash
# NIAC-Go Pre-commit Hook
# Runs tests and checks before allowing commit

set -e

echo "ðŸ” Running pre-commit checks..."
echo ""

# Check if go is available
if ! command -v go &> /dev/null; then
    echo "âŒ Go is not installed or not in PATH"
    exit 1
fi

# Run go fmt check
echo "ðŸ“ Checking code formatting..."
UNFORMATTED=$(gofmt -l .)
if [ -n "$UNFORMATTED" ]; then
    echo "âŒ The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w ."
    exit 1
fi
echo "âœ… Code formatting OK"
echo ""

# Run go vet
echo "ðŸ”Ž Running go vet..."
if ! go vet ./...; then
    echo "âŒ go vet found issues"
    exit 1
fi
echo "âœ… go vet passed"
echo ""

# Run tests
echo "ðŸ§ª Running tests..."
if ! go test -short -race ./...; then
    echo "âŒ Tests failed"
    exit 1
fi
echo "âœ… All tests passed"
echo ""

# Check test coverage
echo "ðŸ“Š Checking test coverage..."
COVERAGE=$(go test -short -coverprofile=/tmp/pre-commit-coverage.out ./... 2>&1 | grep "coverage:" | awk '{print $5}' | sed 's/%//' | head -1)
if [ -n "$COVERAGE" ]; then
    echo "Current coverage: ${COVERAGE}%"
    THRESHOLD=40.0
    if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
        echo "âš ï¸  Warning: Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold"
        # Don't fail the commit, just warn
    else
        echo "âœ… Coverage check passed"
    fi
else
    echo "âš ï¸  Could not determine coverage"
fi
echo ""

# Build check
echo "ðŸ—ï¸  Checking build..."
if ! go build -o /tmp/niac-test ./cmd/niac; then
    echo "âŒ Build failed"
    exit 1
fi
rm -f /tmp/niac-test
echo "âœ… Build successful"
echo ""

echo "âœ… All pre-commit checks passed!"
echo "ðŸš€ Proceeding with commit..."
