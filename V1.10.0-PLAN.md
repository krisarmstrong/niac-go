# NIAC-Go v1.10.0 Plan - Foundation & Validation

**Release Goal**: Modern CLI foundation with validation and better errors
**Timeline**: 2 weeks
**Status**: ðŸ“‹ Planning
**Risk**: ðŸŸ¢ Low (backend only, no complex UI)

---

## Vision

Build the foundation for modern CLI while adding critical validation features:
- **Configuration validation** - Catch errors before simulation starts
- **Modern CLI framework** - Cobra for better command structure
- **Beautiful error messages** - Helpful errors with suggestions
- **Context-aware help** - Rich help text with examples
- **Start test improvements** - Begin journey to 70% coverage

---

## Part 1: Configuration Validation Tool (3 days)

### Feature: `niac validate`

**New Command**:
```bash
# Validate a configuration file
niac validate config.yaml

# Validate with strict mode (warnings as errors)
niac validate --strict config.yaml

# Output JSON for CI/CD integration
niac validate --format json config.yaml

# Validate multiple files
niac validate examples/*.yaml
```

### Enhanced Error Messages

**Before** (v1.9.0):
```
Error: invalid configuration
```

**After** (v1.10.0):
```
âœ— Configuration error in config.yaml

config.yaml:45:12
  |
45|     threshold: ninety
  |                ^^^^^^
  |
Error: Invalid value for 'threshold'
  Expected: integer (0-100)
  Got: string 'ninety'

ðŸ’¡ Suggestion: Use a number: threshold: 90

Need help?
  â€¢ See examples: niac validate examples/
  â€¢ Documentation: https://github.com/krisarmstrong/niac-go#configuration
```

### Implementation

**New Files**:
- `cmd/niac/validate.go` - Validate command implementation
- `pkg/config/validator.go` - Validation logic
- `pkg/config/errors.go` - Structured error types
- `pkg/config/validator_test.go` - Validation tests

**Validation Rules**:
- âœ“ IP address format and ranges (IPv4, IPv6)
- âœ“ MAC address format
- âœ“ Port numbers (1-65535)
- âœ“ Required fields presence
- âœ“ Field type validation
- âœ“ Threshold ranges (0-100%)
- âœ“ Protocol-specific fields
- âœ“ Cross-field dependencies
- âœ“ Duplicate detection (IPs, MACs, device names)

**Structured Errors**:
```go
type ConfigError struct {
    File       string        // config.yaml
    Line       int           // 45
    Column     int           // 12
    Field      string        // "threshold"
    Message    string        // "Invalid value for 'threshold'"
    Expected   string        // "integer (0-100)"
    Got        string        // "string 'ninety'"
    Suggestion string        // "Use a number: threshold: 90"
    Severity   ErrorSeverity // Error, Warning, Info
}
```

**JSON Output** (for CI/CD):
```json
{
  "valid": false,
  "file": "config.yaml",
  "errors": [{
    "line": 45,
    "column": 12,
    "field": "threshold",
    "message": "Invalid value for 'threshold'",
    "expected": "integer (0-100)",
    "got": "string 'ninety'",
    "suggestion": "Use a number: threshold: 90"
  }],
  "warnings": [],
  "summary": {
    "devices": 3,
    "protocols": ["LLDP", "CDP"],
    "errors": 1,
    "warnings": 0
  }
}
```

---

## Part 2: Command Structure with Cobra (3 days)

### Current Structure (v1.9.0)

```bash
./niac [interface] [config]
./niac --interactive [interface] [config]
./niac-convert [file]
```

Problems:
- Positional arguments (confusing)
- No subcommands
- Limited help text
- Inconsistent flags

### New Structure (v1.10.0)

```bash
# Main commands
niac run <config>           # Start simulation
niac validate <config>      # Validate configuration
niac convert <file>         # Convert legacy to YAML
niac version                # Version information
niac help                   # Help system

# Run with options
niac run --interface eth0 config.yaml
niac run --interactive config.yaml
niac run --daemon config.yaml
niac run --debug config.yaml

# Validate options
niac validate config.yaml
niac validate --strict config.yaml
niac validate --format json config.yaml
```

### Implementation

**Dependencies**:
```bash
go get github.com/spf13/cobra@latest
go get github.com/spf13/pflag@latest
```

**New Structure**:
```
cmd/niac/
â”œâ”€â”€ main.go           # Entry point
â”œâ”€â”€ root.go           # Root command setup
â”œâ”€â”€ run.go            # Run command (simulation)
â”œâ”€â”€ validate.go       # Validate command
â”œâ”€â”€ convert.go        # Convert command
â””â”€â”€ version.go        # Version command
```

**Root Command**:
```go
var rootCmd = &cobra.Command{
    Use:   "niac",
    Short: "NIAC-Go - Network In A Can simulator",
    Long: `NIAC-Go is a modern network device simulator that supports
19+ protocols including LLDP, CDP, SNMP, DHCP, and more.

Simulate network devices, generate traffic, and test monitoring tools.`,
    Version: Version,
}
```

**Run Command**:
```go
var runCmd = &cobra.Command{
    Use:   "run [config]",
    Short: "Start network simulation",
    Long: `Start a network device simulation using the specified configuration file.

The simulation will create virtual network devices and begin generating
protocol traffic according to the configuration.`,
    Example: `  # Start simulation with auto-detected interface
  niac run my-network.yaml

  # Specify network interface
  niac run --interface eth0 my-network.yaml

  # Run with interactive dashboard
  niac run --interactive my-network.yaml`,
    Args: cobra.ExactArgs(1),
    RunE: runSimulation,
}
```

**Flags**:
- Consistent naming (--interface, --interactive, --daemon)
- Short flags where appropriate (-i, -d, -v)
- Global flags (--no-color, --verbose, --quiet)
- Validation and defaults

---

## Part 3: Context-Aware Help System (2 days)

### Rich Help Text

Every command gets:
- Clear description
- Usage examples
- Flag documentation
- Related commands
- Links to documentation

### Example: Run Command Help

```bash
$ niac run --help

Start a network simulation

Usage:
  niac run [config] [flags]

Examples:
  # Start with default interface auto-selection
  niac run my-network.yaml

  # Specify network interface
  niac run --interface eth0 my-network.yaml

  # Run in interactive mode with live dashboard
  niac run --interactive my-network.yaml

  # Run in background as daemon
  niac run --daemon my-network.yaml

  # Enable debug logging
  niac run --debug my-network.yaml

Flags:
  -i, --interface string   Network interface (auto-detect if not specified)
  -I, --interactive        Launch interactive dashboard
  -d, --daemon             Run in background as daemon
      --debug              Enable debug logging (level 1-3)

Global Flags:
      --no-color   Disable colored output
  -v, --verbose    Verbose output
  -q, --quiet      Quiet mode (errors only)

Need more help?
  â€¢ Configuration guide: niac help config
  â€¢ Examples:            niac validate examples/*.yaml
  â€¢ Documentation:       https://github.com/krisarmstrong/niac-go
```

### Help Topics

```bash
niac help                  # General help
niac help config           # Configuration guide
niac help protocols        # Protocol configuration
niac help examples         # Usage examples
```

---

## Part 4: Test Coverage - Phase 1 (2 days)

### Current State
- Overall coverage: ~30%
- Config package: ~10%
- Need validation tests

### Target for v1.10.0
- Overall coverage: 40%
- Config package: 50%
- Validator package: 95%

### New Tests (~30 tests)

**pkg/config/validator_test.go**:
```go
func TestValidateIPAddress(t *testing.T)
func TestValidateMACAddress(t *testing.T)
func TestValidatePortNumber(t *testing.T)
func TestValidateThreshold(t *testing.T)
func TestValidateRequiredFields(t *testing.T)
func TestValidateDuplicateDevices(t *testing.T)
func TestValidateProtocolFields(t *testing.T)
// ... 15 more validation tests
```

**pkg/config/errors_test.go**:
```go
func TestConfigErrorFormatting(t *testing.T)
func TestErrorSuggestions(t *testing.T)
func TestJSONErrorOutput(t *testing.T)
// ... 5 more error tests
```

**pkg/config/yaml_test.go** (expand existing):
```go
func TestYAMLInvalidValues(t *testing.T)
func TestYAMLMissingFields(t *testing.T)
func TestYAMLTypeErrors(t *testing.T)
// ... 7 more YAML tests
```

---

## Success Criteria

v1.10.0 is ready when:

- [ ] `niac validate` command working
- [ ] Beautiful error messages with line numbers
- [ ] Suggestions for common mistakes
- [ ] JSON output for CI/CD
- [ ] Cobra command structure implemented
- [ ] All commands use Cobra
- [ ] Rich help text for all commands
- [ ] Examples in help output
- [ ] Config package test coverage â‰¥ 50%
- [ ] Validator test coverage â‰¥ 95%
- [ ] All tests passing
- [ ] Documentation updated
- [ ] README updated with new commands

---

## Timeline

**Day 1-3**: Configuration validation tool
- Validator logic
- Error formatting
- JSON output
- Tests

**Day 4-6**: Cobra integration
- Command structure
- Flag migration
- Help text
- Testing

**Day 7-8**: Context-aware help
- Help topics
- Examples
- Documentation links

**Day 9-10**: Test coverage
- Write new tests
- Fix any bugs found
- Documentation

**Total**: 2 weeks (10 working days)

---

## Migration Notes

### Breaking Changes

**Command syntax changes**:
```bash
# Old (v1.9.0)
./niac eth0 config.yaml

# New (v1.10.0)
niac run --interface eth0 config.yaml
# OR
niac run config.yaml  # auto-detect interface
```

**Backward compatibility**:
- Keep old positional syntax working with deprecation warning
- Show suggestion for new syntax
- Remove in v2.0.0

### Migration Guide

Document in README:
```markdown
## Migrating from v1.9.0 to v1.10.0

### Command Changes

**Old**: `./niac eth0 config.yaml`
**New**: `niac run --interface eth0 config.yaml`

The new command structure provides better help and validation.
Old syntax still works but will show a deprecation warning.
```

---

## Dependencies

**New**:
- github.com/spf13/cobra (CLI framework)
- github.com/spf13/pflag (POSIX flags)

**Size Impact**: ~200KB added (minimal)

---

## Follow-up Work

**Deferred to v1.11.0**:
- Template system
- Quick start wizard
- More test coverage

**Deferred to v1.12.0**:
- Bubble Tea TUI
- Interactive menus
- Live dashboard

**Deferred to v1.13.0**:
- Shell completion
- Config management commands
- Performance benchmarks

---

## Documentation

**Update**:
- README.md - New command syntax
- CHANGELOG.md - v1.10.0 entry
- examples/ - Update all examples

**New**:
- docs/VALIDATION.md - Validation guide
- docs/CLI.md - CLI reference
- docs/MIGRATION.md - v1.9.0 â†’ v1.10.0 guide
