# NIAC-Go v1.8.0 Testing Plan - 90% Coverage Target

**Goal**: Achieve â‰¥90% test coverage across all packages
**Current Overall Coverage**: ~23% (weighted average)
**Target Coverage**: â‰¥90%
**Estimated Tests to Add**: ~250-300 tests

---

## Current Coverage Baseline (v1.7.0)

| Package | Current | Target | Tests Needed |
|---------|---------|--------|--------------|
| pkg/config | 50.6% | 95% | ~30 tests |
| pkg/device | 22.0% | 90% | ~20 tests |
| pkg/protocols | 15.4% | 90% | ~150 tests |
| pkg/snmp | 6.7% | 90% | ~25 tests |
| pkg/errors | 95.1% | 95% | ~2 tests |
| pkg/capture | 0.0% | 85% | ~15 tests |
| pkg/interactive | 0.0% | 85% | ~20 tests |
| pkg/logging | 0.0% | 90% | ~15 tests |

**Total**: ~277 new tests needed

---

## Phase 1: Critical Service Protocols (HIGH PRIORITY)

### DHCP/DHCPv6 Tests (~35 tests)
**Files**: `pkg/protocols/dhcp_test.go`, `pkg/protocols/dhcpv6_test.go`

**DHCPv4 Tests** (~20 tests):
- Handler creation and configuration
- DHCP Discover/Offer handling
- DHCP Request/Ack handling
- DHCP Release/Decline handling
- IP address pool management
- Lease management and expiration
- Option encoding (router, DNS, domain, NTP, etc.)
- Advanced options (TFTP, bootfile, vendor-specific)
- Multiple server configurations
- Error handling (no available IPs, invalid requests)
- Performance benchmarks

**DHCPv6 Tests** (~15 tests):
- Handler creation and configuration
- Solicit/Advertise handling
- Request/Reply handling
- Renew/Rebind handling
- Pool management (IA_NA)
- Advanced options (SNTP, NTP, SIP servers/domains)
- Rapid commit handling
- Error handling
- Performance benchmarks

**Target Coverage**: DHCPv4 90%, DHCPv6 90%

---

### DNS Tests (~20 tests)
**File**: `pkg/protocols/dns_test.go`

**Test Coverage**:
- Handler creation and configuration
- Forward record (A/AAAA) queries
- Reverse record (PTR) queries
- CNAME record handling
- Multiple record types per domain
- Non-existent domain (NXDOMAIN) responses
- Record addition/removal
- Case-insensitive lookups
- IPv4 and IPv6 queries
- Query parsing and response formatting
- Compression handling
- Error handling (malformed queries)
- Performance benchmarks

**Target Coverage**: 90%

---

### HTTP Tests (~20 tests)
**File**: `pkg/protocols/http_test.go`

**Test Coverage**:
- Handler creation and configuration
- Multiple endpoint definitions
- GET request handling
- POST request handling
- Different HTTP methods (PUT, DELETE, HEAD, OPTIONS)
- Path matching and routing
- Status code responses (200, 404, 500, etc.)
- Content-Type headers
- Custom response bodies
- Server identification
- Keep-alive handling
- Error handling (malformed requests)
- Performance benchmarks

**Target Coverage**: 90%

---

### FTP Tests (~25 tests)
**File**: `pkg/protocols/ftp_test.go`

**Test Coverage**:
- Handler creation and configuration
- Connection establishment
- USER/PASS authentication
- Anonymous login
- SYST command
- PWD command
- CWD command
- LIST command
- RETR command
- STOR command
- DELE command
- MKD/RMD commands
- TYPE command (ASCII/Binary)
- PASV/PORT command
- QUIT command
- Welcome banner customization
- Multi-user configuration
- Error handling (invalid commands, auth failures)
- Performance benchmarks

**Target Coverage**: 90%

---

## Phase 2: Discovery Protocols (MEDIUM PRIORITY)

### CDP Tests (~15 tests)
**File**: `pkg/protocols/cdp_test.go`

**Test Coverage**:
- Handler creation and configuration
- CDP frame construction
- Device ID TLV
- Address TLV
- Port ID TLV
- Capabilities TLV
- Software version TLV
- Platform TLV
- IP prefix TLV (if supported)
- Advertisement interval
- Holdtime handling
- Version 1 vs version 2
- Error handling
- Performance benchmarks

**Target Coverage**: 90%

---

### EDP/FDP Tests (~10 tests each = 20 total)
**Files**: `pkg/protocols/edp_test.go`, `pkg/protocols/fdp_test.go`

**EDP Test Coverage**:
- Handler creation
- EDP frame construction
- Display string TLV
- Version string TLV
- Advertisement interval
- Error handling
- Performance benchmarks

**FDP Test Coverage**:
- Handler creation
- FDP frame construction
- Device ID, platform, version
- Port ID
- Advertisement interval
- Holdtime handling
- Error handling
- Performance benchmarks

**Target Coverage**: 85% each

---

## Phase 3: Network Layer Protocols (MEDIUM PRIORITY)

### ICMP Tests (~15 tests)
**File**: `pkg/protocols/icmp_test.go`

**Test Coverage**:
- Handler creation
- Echo request handling
- Echo reply construction
- TTL handling
- Payload echo
- Identifier and sequence number handling
- Checksum calculation
- ICMP type/code handling
- Error handling
- Performance benchmarks

**Target Coverage**: 90%

---

### IP/IPv6 Tests (~15 tests)
**Files**: `pkg/protocols/ip_test.go` (expand existing ipv6_test.go)

**Test Coverage**:
- Handler creation
- Packet parsing
- Fragment handling
- TTL/Hop limit handling
- Protocol identification
- Checksum validation
- IPv4 options handling
- IPv6 extension headers
- Error handling
- Performance benchmarks

**Target Coverage**: 85%

---

### TCP/UDP Tests (~20 tests)
**Files**: `pkg/protocols/tcp_test.go`, `pkg/protocols/udp_test.go`

**TCP Test Coverage** (~12 tests):
- Handler creation
- RST response generation
- SYN/ACK handling
- Checksum calculation
- IPv4 and IPv6 support
- Port handling
- Error handling
- Performance benchmarks

**UDP Test Coverage** (~8 tests):
- Handler creation
- Packet parsing
- Checksum handling
- IPv4 and IPv6 support
- Port handling
- Error handling
- Performance benchmarks

**Target Coverage**: 85% each

---

## Phase 4: Core Infrastructure (HIGH PRIORITY)

### Capture Package Tests (~15 tests)
**File**: `pkg/capture/capture_test.go`

**Test Coverage**:
- Interface listing
- Interface existence checks
- Interface selection
- Capture engine creation
- Packet sending
- Error handling (invalid interface, permission denied)
- Resource cleanup
- Performance benchmarks

**Target Coverage**: 85%

---

### Logging Package Tests (~15 tests)
**File**: `pkg/logging/logging_test.go`

**Test Coverage**:
- DebugConfig creation
- Global debug level setting
- Per-protocol debug level setting
- Debug level retrieval
- Color initialization
- Color disable (NO_COLOR, --no-color)
- Message formatting
- Protocol-specific logging
- Log level filtering
- Error/Success/Info message formatting
- Performance benchmarks

**Target Coverage**: 90%

---

### Stack Integration Tests (~20 tests)
**File**: `pkg/protocols/stack_integration_test.go`

**Test Coverage**:
- Stack creation with full config
- Multi-device simulation
- Packet routing between protocols
- Statistics tracking
- Device state management
- Protocol handler registration
- Concurrent packet handling
- Resource cleanup
- End-to-end scenarios
- Performance benchmarks

**Target Coverage**: 85%

---

## Phase 5: Expand Existing Coverage

### Config Package Expansion (~30 tests)
**Expand**: `pkg/config/yaml_test.go`

**Additional Test Coverage**:
- All protocol configurations (currently missing 13 protocols)
- Edge cases (very large configs, minimal configs)
- Performance with 100+ devices
- Concurrent config loading
- Config reload scenarios

**Target Coverage**: 95%

---

### Device Package Expansion (~20 tests)
**Expand**: `pkg/device/simulator_test.go`

**Additional Test Coverage**:
- Traffic generation edge cases
- SNMP walk file loading
- Error state management
- Performance under load
- Multi-device interactions

**Target Coverage**: 90%

---

### SNMP Package Expansion (~25 tests)
**Files**: Expand `pkg/snmp/traps_test.go`, add `pkg/snmp/agent_test.go`

**Additional Test Coverage**:
- SNMP agent GET requests
- SNMP agent GETNEXT requests
- SNMP agent SET requests
- Walk file parsing
- OID tree navigation
- Trap generation under load
- Community string validation
- Error handling

**Target Coverage**: 90%

---

## Phase 6: Interactive & Advanced

### Interactive Package Tests (~20 tests)
**File**: `pkg/interactive/tui_test.go`

**Test Coverage**:
- TUI model creation
- State updates
- Key handling
- View rendering
- Error injection mode
- Statistics display
- Device status display
- Integration with bubble tea

**Target Coverage**: 85%

---

## Implementation Strategy

### Week 1: Critical Protocols
- **Day 1-2**: DHCP/DHCPv6 tests (~35 tests)
- **Day 3**: DNS tests (~20 tests)
- **Day 4**: HTTP tests (~20 tests)
- **Day 5**: FTP tests (~25 tests)

**Total Week 1**: ~100 tests, Protocol coverage â†’ 50-60%

### Week 2: Discovery & Network Layer
- **Day 1**: CDP tests (~15 tests)
- **Day 2**: EDP/FDP tests (~20 tests)
- **Day 3**: ICMP tests (~15 tests)
- **Day 4**: TCP/UDP tests (~20 tests)
- **Day 5**: IP/IPv6 expansion (~15 tests)

**Total Week 2**: ~85 tests, Protocol coverage â†’ 80%+

### Week 3: Infrastructure & Integration
- **Day 1**: Capture tests (~15 tests)
- **Day 2**: Logging tests (~15 tests)
- **Day 3-4**: Stack integration tests (~20 tests)
- **Day 5**: Config/Device/SNMP expansion (~30 tests)

**Total Week 3**: ~80 tests, Overall coverage â†’ 85%+

### Week 4: Polish & Interactive
- **Day 1-2**: Interactive tests (~20 tests)
- **Day 3-4**: Final coverage gaps (~20 tests)
- **Day 5**: Documentation and release prep

**Total Week 4**: ~40 tests, Overall coverage â†’ 90%+

---

## Success Criteria

âœ… **Package Coverage**:
- pkg/config: â‰¥95%
- pkg/device: â‰¥90%
- pkg/protocols: â‰¥90%
- pkg/snmp: â‰¥90%
- pkg/errors: â‰¥95%
- pkg/capture: â‰¥85%
- pkg/interactive: â‰¥85%
- pkg/logging: â‰¥90%

âœ… **Protocol Coverage**:
- All 19 protocols have dedicated test files
- Each protocol has â‰¥85% coverage
- Critical protocols (DHCP, DNS, HTTP, FTP) have â‰¥90% coverage

âœ… **Test Quality**:
- All tests pass consistently
- Comprehensive error handling tests
- Performance benchmarks for critical paths
- Thread-safety tests where applicable

âœ… **Overall Target**:
- **Total coverage: â‰¥90%**
- **Total tests: 350-400 tests** (currently 87)
- **All critical code paths tested**

---

## Estimated Effort

- **Total new tests**: ~277-300 tests
- **Total new code**: ~10,000-12,000 lines of test code
- **Time estimate**: 15-20 development sessions
- **Target completion**: v1.8.0 release

---

**Status**: ðŸ“‹ Planning Complete
**Next Step**: Begin Phase 1 - DHCP/DHCPv6 tests
