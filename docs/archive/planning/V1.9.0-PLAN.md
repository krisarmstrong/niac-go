# NIAC-Go v1.9.0 Plan - Enhanced Testing & Quality

**Release Goal**: Reach 70%+ test coverage and improve configuration validation
**Timeline**: 3-4 weeks
**Status**: üìã Planning

---

## Overview

Building on v1.8.0's foundation (44.8% coverage, 209 tests), v1.9.0 focuses on:
1. Expanding test coverage to 70%+
2. Adding configuration validation tool
3. Improving error messages and user experience
4. Performance benchmarking and optimization

---

## Part 1: Expanded Test Coverage (Target: 70%+)

### Current State (v1.8.0)
- Overall: 44.8% coverage
- pkg/protocols: Good coverage on critical paths
- pkg/config: Limited coverage
- pkg/device: Limited coverage
- pkg/snmp: Limited coverage
- pkg/capture: No coverage
- pkg/interactive: No coverage
- pkg/logging: No coverage

### 1.1 Config Package Tests (Week 1, Days 1-2)

**Target**: 95% coverage (currently ~10%)

**Test Files**:
- Expand `pkg/config/yaml_test.go`
- New `pkg/config/validator_test.go`

**Coverage**:
- ‚úÖ Basic YAML parsing (done in v1.8.0)
- ‚ùå All 19 protocol YAML configurations
- ‚ùå Multi-device configurations (10+ devices)
- ‚ùå Traffic pattern validation
- ‚ùå SNMP trap configuration validation
- ‚ùå IP address pool validation (DHCP/DHCPv6)
- ‚ùå Edge cases (empty configs, malformed YAML)
- ‚ùå Error message validation
- ‚ùå Config merging/inheritance
- ‚ùå Default value handling

**Estimated**: ~30 tests

### 1.2 Device Simulator Tests (Week 1, Days 3-4)

**Target**: 90% coverage (currently ~22%)

**Test Files**:
- Expand `pkg/device/simulator_test.go`
- New `pkg/device/traffic_test.go`

**Coverage**:
- ‚ùå Device lifecycle (start, stop, restart)
- ‚ùå Traffic generation (all types: ARP, ping, random)
- ‚ùå Per-device traffic configuration
- ‚ùå Concurrent multi-device simulation (50+ devices)
- ‚ùå Resource cleanup and leak detection
- ‚ùå Statistics collection and reporting
- ‚ùå Error state handling and recovery
- ‚ùå Device state transitions
- ‚ùå Protocol enable/disable dynamically

**Estimated**: ~25 tests

### 1.3 SNMP Package Tests (Week 1, Day 5 - Week 2, Day 1)

**Target**: 90% coverage (currently ~7%)

**Test Files**:
- New `pkg/snmp/agent_test.go`
- Expand `pkg/snmp/traps_test.go`
- New `pkg/snmp/mib_test.go`

**Coverage**:
- ‚ùå SNMP agent initialization and configuration
- ‚ùå GET request handling
- ‚ùå GET-NEXT request handling
- ‚ùå Walk file loading and parsing
- ‚ùå OID tree navigation
- ‚ùå MIB-II system group responses
- ‚ùå Trap generation (all types)
- ‚ùå Trap PDU formatting (SNMPv2c)
- ‚ùå Threshold-based trap triggers
- ‚ùå Multiple trap receivers
- ‚ùå Community string validation
- ‚ùå Error responses (noSuchObject, etc.)

**Estimated**: ~30 tests

### 1.4 Capture Package Tests (Week 2, Days 2-3)

**Target**: 85% coverage (currently 0%)

**Test Files**:
- New `pkg/capture/capture_test.go`
- New `pkg/capture/playback_test.go`

**Coverage**:
- ‚ùå Interface listing and discovery
- ‚ùå Interface validation
- ‚ùå Packet capture initialization
- ‚ùå Packet sending (raw Ethernet frames)
- ‚ùå Error handling (permission denied, invalid interface)
- ‚ùå Resource cleanup
- ‚ùå Playback file reading
- ‚ùå Playback timing control

**Estimated**: ~20 tests

### 1.5 Interactive Package Tests (Week 2, Day 4)

**Target**: 85% coverage (currently 0%)

**Test Files**:
- New `pkg/interactive/interactive_test.go`
- New `pkg/interactive/tui_test.go`

**Coverage**:
- ‚ùå TUI model creation and initialization
- ‚ùå State updates (device stats, protocol stats)
- ‚ùå Key handling (navigation, commands)
- ‚ùå Error injection mode
- ‚ùå Device status display
- ‚ùå Statistics formatting
- ‚ùå Menu navigation

**Estimated**: ~20 tests

### 1.6 Logging Package Tests (Week 2, Day 5)

**Target**: 90% coverage (currently 0%)

**Test Files**:
- New `pkg/logging/logging_test.go`
- New `pkg/logging/debug_config_test.go`

**Coverage**:
- ‚ùå DebugConfig creation
- ‚ùå Global debug level setting
- ‚ùå Per-protocol debug levels
- ‚ùå Color initialization
- ‚ùå NO_COLOR environment variable handling
- ‚ùå Message formatting
- ‚ùå Log level filtering
- ‚ùå Concurrent logging safety

**Estimated**: ~15 tests

### 1.7 Integration Tests (Week 3, Days 1-2)

**Target**: Full end-to-end scenarios

**Test Files**:
- New `tests/integration/simulation_test.go`
- New `tests/integration/snmp_test.go`
- New `tests/integration/traffic_test.go`

**Coverage**:
- ‚ùå Full device simulation (multiple devices)
- ‚ùå Traffic generation with SNMP traps
- ‚ùå SNMP queries during simulation
- ‚ùå Configuration reload
- ‚ùå Graceful shutdown
- ‚ùå Error recovery scenarios
- ‚ùå Performance under load (100+ devices)

**Estimated**: ~25 tests

**Total New Tests for v1.9.0**: ~165 tests
**Total Tests After v1.9.0**: ~374 tests
**Expected Coverage**: 70-75%

---

## Part 2: Configuration Validation Tool (Week 3, Days 3-4)

### Feature: `niac validate`

**Command Usage**:
```bash
# Validate a single file
./niac validate examples/complete-kitchen-sink.yaml

# Validate all examples
./niac validate examples/*.yaml

# Strict mode (warnings as errors)
./niac validate --strict config.yaml

# Output JSON for CI/CD
./niac validate --format json config.yaml
```

**Output Examples**:

**Success**:
```
‚úì Configuration is valid: examples/complete-kitchen-sink.yaml

  Summary:
    Devices: 9
    Protocols: LLDP, CDP, HTTP, DHCP, DHCPv6, SNMP
    Traffic generation: 2 devices
    SNMP traps: 1 device configured

  Device List:
    ‚úì cisco-r1 (192.168.1.1) - LLDP, CDP, SNMP
    ‚úì hp-sw1 (192.168.1.2) - LLDP, CDP
    ‚úì web-server (192.168.1.10) - HTTP, DNS
    ... (6 more)
```

**Errors**:
```
‚úó Configuration errors found: examples/broken.yaml

examples/broken.yaml:45:12
  |
45|     threshold: ninety
  |                ^^^^^^
  |
Error: Invalid value for 'threshold'
  Expected: integer (0-100)
  Got: string 'ninety'
  Suggestion: Use a number: threshold: 90

examples/broken.yaml:78:8
  |
78|     - ip: 192.168.1.999
  |           ^^^^^^^^^^^^^
  |
Error: Invalid IP address
  Reason: Octet value 999 exceeds 255

Summary: 2 errors, 0 warnings
```

**JSON Output** (for CI/CD):
```json
{
  "valid": false,
  "file": "examples/broken.yaml",
  "errors": [
    {
      "line": 45,
      "column": 12,
      "field": "threshold",
      "message": "Invalid value for 'threshold'",
      "expected": "integer (0-100)",
      "got": "string 'ninety'",
      "suggestion": "Use a number: threshold: 90"
    }
  ],
  "warnings": [],
  "summary": {
    "devices": 0,
    "protocols": [],
    "errors": 2,
    "warnings": 0
  }
}
```

**Implementation**:
- New `cmd/niac/validate.go`
- New `pkg/config/validator.go` (validation logic)
- Enhanced `pkg/config/errors.go` (structured errors)
- Integration with existing YAML parser

**Validation Rules**:
- IP address format and ranges
- MAC address format
- Port numbers (1-65535)
- Protocol-specific field validation
- Required fields presence
- Field type validation
- Cross-field dependencies
- Duplicate detection (IPs, MACs, names)

---

## Part 3: Enhanced Error Messages (Week 3, Day 5)

### Current Issues
- Generic errors without context
- No line/column numbers for YAML errors
- Stack traces visible to users
- No suggestions for fixes

### Improvements

**1. Contextual Error Messages**
- Show file path, line, column
- Display snippet of problematic YAML
- Provide fix suggestions
- Color-coded output

**2. Error Categories**
- Configuration errors (red)
- Warnings (yellow)
- Info messages (blue)
- Success (green)

**3. Structured Errors**
```go
type ConfigError struct {
    File       string
    Line       int
    Column     int
    Field      string
    Message    string
    Expected   string
    Got        string
    Suggestion string
    Severity   ErrorSeverity // Error, Warning, Info
}
```

**4. Error Context Provider**
```go
func (e *ConfigError) Format() string {
    // Returns formatted, color-coded error with context
}
```

---

## Part 4: Performance & Benchmarking (Week 4)

### 4.1 Benchmark Suite

**Files**:
- `pkg/config/config_bench_test.go`
- `pkg/device/traffic_bench_test.go`
- `pkg/snmp/snmp_bench_test.go`
- `pkg/protocols/protocols_bench_test.go`
- `benchmarks/full_simulation_bench_test.go`

**Benchmarks**:
- Config parsing (YAML vs simple format)
- Device creation and initialization
- Packet generation rate
- Protocol handler performance
- SNMP query response time
- Trap generation rate
- Memory allocation patterns
- Concurrent device simulation (10, 50, 100, 500 devices)

### 4.2 Performance Goals

**Targets** (compared to Java NIAC):
- Startup time: 10x faster ‚úÖ (already achieved)
- Error injection: 77x faster ‚úÖ (already achieved)
- Packet generation: 1M+ packets/sec
- SNMP response: <1ms
- Memory usage: 50% reduction
- Device scaling: 500+ concurrent devices

### 4.3 Performance Monitoring

**New Features**:
- Built-in pprof endpoint
- CPU and memory profiling
- Packet rate statistics
- Device performance metrics
- Real-time performance dashboard

**Usage**:
```bash
# Enable profiling
./niac --profile --profile-port 6060 eth0 config.yaml

# In another terminal
go tool pprof http://localhost:6060/debug/pprof/profile
```

---

## Part 5: Documentation Improvements

### 5.1 API Documentation
- Complete GoDoc comments for all exported types
- Architecture diagrams (Mermaid)
- Protocol implementation guides
- Performance tuning guide

### 5.2 User Guides
- Getting started tutorial
- Configuration guide (comprehensive)
- Protocol configuration examples (all 19)
- Traffic generation guide
- SNMP simulation guide
- Troubleshooting guide
- FAQ

### 5.3 Developer Documentation
- Contributing guide
- Testing guide
- Code structure overview
- Adding new protocols
- CI/CD pipeline documentation

---

## Success Criteria

v1.9.0 is ready when:

- [ ] Overall test coverage ‚â• 70%
- [ ] Config package ‚â• 95% coverage
- [ ] Device package ‚â• 90% coverage
- [ ] SNMP package ‚â• 90% coverage
- [ ] Capture, interactive, logging ‚â• 85% coverage
- [ ] Integration test suite passing
- [ ] `niac validate` command working
- [ ] Enhanced error messages implemented
- [ ] Performance benchmarks show no regression
- [ ] All documentation updated
- [ ] All tests passing in CI/CD

---

## Timeline Summary

**Week 1**: Config, Device, SNMP tests (~85 tests)
**Week 2**: Capture, Interactive, Logging tests (~55 tests)
**Week 3**: Integration tests, Validation tool, Error messages (~25 tests)
**Week 4**: Performance benchmarking, documentation, polish

**Total Effort**: 3-4 weeks

---

## Deferred to v1.10.0

These items from v1.7.0 plan are moved to v1.10.0:
- Interactive mode enhancements (full TUI)
- Progress indicators and status display
- Configuration hot-reload
- Advanced CLI menu structure
